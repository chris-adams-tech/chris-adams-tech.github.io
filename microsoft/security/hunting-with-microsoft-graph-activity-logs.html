<!DOCTYPE html> <html><head>
		<title>Hunting with Microsoft Graph activity logs</title>
		<base href="..\../">
		<meta id="root-path" root-path="..\../">
		<meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=yes, minimum-scale=1.0, maximum-scale=5.0">
		<meta charset="UTF-8">
		<meta name="description" content="Chris Adams Cyber Garden - Hunting with Microsoft Graph activity logs">
		<meta property="og:title" content="Hunting with Microsoft Graph activity logs">
		<meta property="og:description" content="Chris Adams Cyber Garden - Hunting with Microsoft Graph activity logs">
		<meta property="og:type" content="website">
		<meta property="og:url" content="https://chris-adams-tech.github.io/microsoft/security/hunting-with-microsoft-graph-activity-logs.html">
		<meta property="og:image" content="https://chris-adams-tech.github.io/lib/media/graph-dash.png">
		<meta property="og:site_name" content="Chris Adams Cyber Garden">
		<meta name="author" content="Chris Adams"><link rel="alternate" type="application/rss+xml" title="RSS Feed" href="https://chris-adams-tech.github.io/lib/rss.xml"><script async="" id="webpage-script" src="lib/scripts/webpage.js" onload="this.onload=null;this.setAttribute(&quot;loaded&quot;, &quot;true&quot;)"></script><script type="module" async="" id="graph-view-script" src="lib/scripts/graph-view.js"></script><script async="" id="graph-wasm-script" src="lib/scripts/graph-wasm.js" onload="this.onload=null;this.setAttribute(&quot;loaded&quot;, &quot;true&quot;)"></script><script async="" id="graph-render-worker-script" src="lib/scripts/graph-render-worker.js" onload="this.onload=null;this.setAttribute(&quot;loaded&quot;, &quot;true&quot;)"></script><script async="" id="tinycolor-script" src="lib/scripts/tinycolor.js" onload="this.onload=null;this.setAttribute(&quot;loaded&quot;, &quot;true&quot;)"></script><script async="" id="pixi-script" src="https://cdnjs.cloudflare.com/ajax/libs/pixi.js/7.4.0/pixi.min.js" onload="this.onload=null;this.setAttribute(&quot;loaded&quot;, &quot;true&quot;)"></script><script async="" id="minisearch-script" src="https://cdn.jsdelivr.net/npm/minisearch@6.3.0/dist/umd/index.min.js" onload="this.onload=null;this.setAttribute(&quot;loaded&quot;, &quot;true&quot;)"></script><script async="" id="graph-data-script" src="lib/scripts/graph-data.js" onload="this.onload=null;this.setAttribute(&quot;loaded&quot;, &quot;true&quot;)"></script><style>body{--line-width:40em;--line-width-adaptive:40em;--file-line-width:40em;--sidebar-width:min(20em, 80vw);--collapse-arrow-size:11px;--tree-horizontal-spacing:0.6em;--tree-vertical-spacing:0.6em;--sidebar-margin:12px}.sidebar{height:100%;min-width:calc(var(--sidebar-width) + var(--divider-width-hover));max-width:calc(var(--sidebar-width) + var(--divider-width-hover));font-size:14px;z-index:10;position:relative;overflow:hidden;transition:min-width ease-in-out,max-width ease-in-out;transition-duration:.2s;contain:size}.sidebar-left{left:0}.sidebar-right{right:0}.sidebar.is-collapsed{min-width:0;max-width:0}body.floating-sidebars .sidebar{position:absolute}.sidebar-content{height:100%;min-width:calc(var(--sidebar-width) - var(--divider-width-hover));top:0;padding:var(--sidebar-margin);padding-top:4em;line-height:var(--line-height-tight);background-color:var(--background-secondary);transition:background-color,border-right,border-left,box-shadow;transition-duration:var(--color-fade-speed);transition-timing-function:ease-in-out;position:absolute;display:flex;flex-direction:column}.sidebar:not(.is-collapsed) .sidebar-content{min-width:calc(max(100%,var(--sidebar-width)) - 3px);max-width:calc(max(100%,var(--sidebar-width)) - 3px)}.sidebar-left .sidebar-content{left:0;border-top-right-radius:var(--radius-l);border-bottom-right-radius:var(--radius-l)}.sidebar-right .sidebar-content{right:0;border-top-left-radius:var(--radius-l);border-bottom-left-radius:var(--radius-l)}.sidebar:has(.sidebar-content:empty):has(.topbar-content:empty){display:none}.sidebar-topbar{height:2em;width:var(--sidebar-width);top:var(--sidebar-margin);padding-inline:var(--sidebar-margin);z-index:1;position:fixed;display:flex;align-items:center;transition:width ease-in-out;transition-duration:inherit}.sidebar.is-collapsed .sidebar-topbar{width:calc(2.3em + var(--sidebar-margin) * 2)}.sidebar .sidebar-topbar.is-collapsed{width:0}.sidebar-left .sidebar-topbar{left:0}.sidebar-right .sidebar-topbar{right:0}.topbar-content{overflow:hidden;overflow:clip;width:100%;height:100%;display:flex;align-items:center;transition:inherit}.sidebar.is-collapsed .topbar-content{width:0;transition:inherit}.clickable-icon.sidebar-collapse-icon{background-color:transparent;color:var(--icon-color-focused);padding:0!important;margin:0!important;height:100%!important;width:2.3em!important;margin-inline:0.14em!important;position:absolute}.sidebar-left .clickable-icon.sidebar-collapse-icon{transform:rotateY(180deg);right:var(--sidebar-margin)}.sidebar-right .clickable-icon.sidebar-collapse-icon{transform:rotateY(180deg);left:var(--sidebar-margin)}.clickable-icon.sidebar-collapse-icon svg.svg-icon{width:100%;height:100%}.sidebar-section-header{margin:0 0 1em 0;text-transform:uppercase;letter-spacing:.06em;font-weight:600}body{transition:background-color var(--color-fade-speed) ease-in-out}.webpage-container{display:flex;flex-direction:row;height:100%;width:100%;align-items:stretch;justify-content:center}.document-container{opacity:1;flex-basis:100%;max-width:100%;width:100%;height:100%;display:flex;flex-direction:column;align-items:center;transition:opacity .2s ease-in-out;contain:inline-size}.hide{opacity:0;transition:opacity .2s ease-in-out}.document-container>.markdown-preview-view{margin:var(--sidebar-margin);margin-bottom:0;width:100%;width:-webkit-fill-available;width:-moz-available;width:fill-available;background-color:var(--background-primary);transition:background-color var(--color-fade-speed) ease-in-out;border-top-right-radius:var(--window-radius,var(--radius-m));border-top-left-radius:var(--window-radius,var(--radius-m));overflow-x:hidden!important;overflow-y:auto!important;display:flex!important;flex-direction:column!important;align-items:center!important;contain:inline-size}.document-container>.markdown-preview-view>.markdown-preview-sizer{padding-bottom:80vh!important;width:100%!important;max-width:var(--line-width)!important;flex-basis:var(--line-width)!important;transition:background-color var(--color-fade-speed) ease-in-out;contain:inline-size}.markdown-rendered img:not([width]),.view-content img:not([width]){max-width:100%;outline:0}.document-container>.view-content.embed{display:flex;padding:1em;height:100%;width:100%;align-items:center;justify-content:center}.document-container>.view-content.embed>*{max-width:100%;max-height:100%;object-fit:contain}:has(> :is(.math,table)){overflow-x:auto!important}.document-container>.view-content{overflow-x:auto;contain:content;padding:0;margin:0;height:100%}.scroll-highlight{position:absolute;width:100%;height:100%;pointer-events:none;z-index:1000;background-color:hsla(var(--color-accent-hsl),.25);opacity:0;padding:1em;inset:50%;translate:-50% -50%;border-radius:var(--radius-s)}</style><script defer="">async function loadIncludes(){if("file:"!=location.protocol){let e=document.querySelectorAll("include");for(let t=0;t<e.length;t++){let o=e[t],l=o.getAttribute("src");try{const e=await fetch(l);if(!e.ok){console.log("Could not include file: "+l),o?.remove();continue}let t=await e.text(),n=document.createRange().createContextualFragment(t),i=Array.from(n.children);for(let e of i)e.classList.add("hide"),e.style.transition="opacity 0.5s ease-in-out",setTimeout((()=>{e.classList.remove("hide")}),10);o.before(n),o.remove(),console.log("Included file: "+l)}catch(e){o?.remove(),console.log("Could not include file: "+l,e);continue}}}else{if(document.querySelectorAll("include").length>0){var e=document.createElement("div");e.id="error",e.textContent="Web server exports must be hosted on an http / web server to be viewed correctly.",e.style.position="fixed",e.style.top="50%",e.style.left="50%",e.style.transform="translate(-50%, -50%)",e.style.fontSize="1.5em",e.style.fontWeight="bold",e.style.textAlign="center",document.body.appendChild(e),document.querySelector(".document-container")?.classList.remove("hide")}}}document.addEventListener("DOMContentLoaded",(()=>{loadIncludes()}));let isFileProtocol="file:"==location.protocol;function waitLoadScripts(e,t){let o=e.map((e=>document.getElementById(e+"-script"))),l=0;!function e(){let n=o[l];l++,n&&"true"!=n.getAttribute("loaded")||l<o.length&&e(),l<o.length?n.addEventListener("load",e):t()}()}</script><link rel="stylesheet" href="lib/styles/obsidian.css"><link rel="preload" href="lib/styles/other-plugins.css" as="style" onload="this.onload=null;this.rel='stylesheet'"><noscript><link rel="stylesheet" href="lib/styles/other-plugins.css"></noscript><link rel="stylesheet" href="lib/styles/theme.css"><link rel="preload" href="lib/styles/global-variable-styles.css" as="style" onload="this.onload=null;this.rel='stylesheet'"><noscript><link rel="stylesheet" href="lib/styles/global-variable-styles.css"></noscript><link rel="preload" href="lib/styles/main-styles.css" as="style" onload="this.onload=null;this.rel='stylesheet'"><noscript><link rel="stylesheet" href="lib/styles/main-styles.css"></noscript></head><body class="publish css-settings-manager theme-dark show-inline-title show-ribbon"><script defer="">let theme=localStorage.getItem("theme")||(window.matchMedia("(prefers-color-scheme: dark)").matches?"dark":"light");"dark"==theme?(document.body.classList.add("theme-dark"),document.body.classList.remove("theme-light")):(document.body.classList.add("theme-light"),document.body.classList.remove("theme-dark")),window.innerWidth<480?document.body.classList.add("is-phone"):window.innerWidth<768?document.body.classList.add("is-tablet"):window.innerWidth<1024?document.body.classList.add("is-small-screen"):document.body.classList.add("is-large-screen")</script><div class="webpage-container workspace"><div class="sidebar-left sidebar"><div class="sidebar-handle"></div><div class="sidebar-topbar"><div class="topbar-content"><label class="theme-toggle-container" for="theme_toggle"><input class="theme-toggle-input" type="checkbox" id="theme_toggle"><div class="toggle-background"></div></label></div><div class="clickable-icon sidebar-collapse-icon"><svg xmlns="http://www.w3.org/2000/svg" width="100%" height="100%" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="3" stroke-linecap="round" stroke-linejoin="round" class="svg-icon"><path d="M21 3H3C1.89543 3 1 3.89543 1 5V19C1 20.1046 1.89543 21 3 21H21C22.1046 21 23 20.1046 23 19V5C23 3.89543 22.1046 3 21 3Z"></path><path d="M10 4V20"></path><path d="M4 7H7"></path><path d="M4 10H7"></path><path d="M4 13H7"></path></svg></div></div><div class="sidebar-content"><div class="search-input-container"><input enterkeyhint="search" type="search" spellcheck="false" placeholder="Search..."><div class="search-input-clear-button" aria-label="Clear search"></div></div><include src="lib/html/file-tree.html"></include></div><script defer="">let ls = document.querySelector(".sidebar-left"); ls.classList.add("is-collapsed"); if (window.innerWidth > 768) ls.classList.remove("is-collapsed"); ls.style.setProperty("--sidebar-width", localStorage.getItem("sidebar-left-width"));</script></div><div class="document-container markdown-reading-view hide"><div class="markdown-preview-view markdown-rendered allow-fold-headings allow-fold-lists is-readable-line-width"><style id="MJX-CHTML-styles"></style><pre class="frontmatter language-yaml" tabindex="0" style="display: none;"><code class="language-yaml is-loaded"><span class="token key atrule">tags</span><span class="token punctuation">:</span>
  <span class="token punctuation">-</span> self<span class="token punctuation">-</span>created
  <span class="token punctuation">-</span> notes
  <span class="token punctuation">-</span> active<span class="token punctuation">-</span>directory</code><button class="copy-code-button">Copy</button></pre><div class="markdown-preview-sizer markdown-preview-section"><h1 class="page-title heading inline-title" id="Hunting with Microsoft Graph activity logs">Hunting with Microsoft Graph activity logs</h1><div class="el-p"><p dir="auto"><a rel="noopener nofollow" class="external-link" href="https://techcommunity.microsoft.com/t5/microsoft-security-experts-blog/hunting-with-microsoft-graph-activity-logs/ba-p/4234632" target="_blank">https://techcommunity.microsoft.com/t5/microsoft-security-experts-blog/hunting-with-microsoft-graph-activity-logs/ba-p/4234632</a><br>
See link above for more detailed information</p></div><div class="el-p"><p dir="auto"><strong>Microsoft graph &gt; Unified</strong> <strong><a data-href="RESTFUL API" href="networking/restful-api.html" class="internal-link" target="_self" rel="noopener nofollow">RESTFUL API</a></strong> <strong>endpoint that allows you to query data from various sources, including data stored in Microsoft 365.</strong></p></div><div class="el-ul"><ul>
<li data-line="0" dir="auto">If compromised, a threat actor may be able to read emails or files on Sharepoint, or more.</li>
</ul></div><div class="el-div"><div data-callout-metadata="" data-callout-fold="" data-callout="important" class="callout"><div class="callout-title" dir="auto"><div class="callout-icon"><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="svg-icon lucide-flame"><path d="M8.5 14.5A2.5 2.5 0 0 0 11 12c0-1.38-.5-2-1-3-1.072-2.143-.224-4.054 2-6 .5 2.5 2 4.9 4 6.5 2 1.6 3 3.5 3 5.5a7 7 0 1 1-14 0c0-1.153.433-2.294 1-3a2.5 2.5 0 0 0 2.5 2.5z"></path></svg></div><div class="callout-title-inner">Important</div></div><div class="callout-content">
<p dir="auto">This was just made available to the general public on April 11th, 2024<br>
<a rel="noopener nofollow" class="external-link" href="https://techcommunity.microsoft.com/t5/microsoft-entra-blog/microsoft-graph-activity-logs-is-now-generally-available/ba-p/4094535" target="_blank">https://techcommunity.microsoft.com/t5/microsoft-entra-blog/microsoft-graph-activity-logs-is-now-generally-available/ba-p/4094535</a><br>
<span alt="graph-dash.png" src="graph-dash.png" class="internal-embed media-embed image-embed is-loaded"><img alt="graph-dash.png" src="lib/media/graph-dash.png"></span></p>
</div></div></div><div class="el-p"><p dir="auto">This will allow users to do the following in their tenant:</p></div><div class="el-ul"><ul>
<li data-line="0" dir="auto">perform security analysis</li>
<li data-line="1" dir="auto">threat hunting</li>
<li data-line="2" dir="auto">monitor application activity</li>
</ul></div><div class="el-p"><p dir="auto">These logs will be viewable in the Log Analytics workspace in your Azure tenant.</p></div><div class="el-blockquote"><blockquote dir="auto">
<p>The Microsoft Graph activity logs will allow the administrator to see authentication activity and audit logs to see changes to important resources.</p>
</blockquote></div><div class="el-ul"><ul>
<li data-line="0" dir="auto">from token request in sign-in logs, to API request activity (reads, writes, and deletes), to resource changes</li>
</ul></div><div class="el-div"><div data-callout-metadata="" data-callout-fold="" data-callout="important" class="callout"><div class="callout-title" dir="auto"><div class="callout-icon"><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="svg-icon lucide-flame"><path d="M8.5 14.5A2.5 2.5 0 0 0 11 12c0-1.38-.5-2-1-3-1.072-2.143-.224-4.054 2-6 .5 2.5 2 4.9 4 6.5 2 1.6 3 3.5 3 5.5a7 7 0 1 1-14 0c0-1.153.433-2.294 1-3a2.5 2.5 0 0 0 2.5 2.5z"></path></svg></div><div class="callout-title-inner">Important</div></div><div class="callout-content">
<p dir="auto">Microsoft recommends to&nbsp;estimate the cost&nbsp;before collecting the logs. Depending on your tenant, there might be a high volume of logs generated.  </p>
</div></div></div><div class="el-p"><p dir="auto">Common use cases:</p></div><div class="el-ul"><ul>
<li data-line="0" dir="auto">identifying compromised user activities</li>
<li data-line="1" dir="auto"><div class="list-collapse-indicator collapse-indicator collapse-icon"><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="svg-icon right-triangle"><path d="M3 8L12 17L21 8"></path></svg></div>building detections and behavorial analysis for suspicious/anomalous activity
<ul>
<li data-line="2" dir="auto">ex. application enumerating all users, making probe requests with many 403 errors.</li>
</ul>
</li>
<li data-line="3" dir="auto">investigating unexpected or unnecessarily privileged assignments of application permissions</li>
<li data-line="4" dir="auto">identifying problematic or unexpected behaviors for client applications</li>
</ul></div><div class="el-p"><p dir="auto">Field Names and descriptions:</p></div><div class="el-table" dir="ltr" style="overflow-x: auto;"><table>
<thead>
<tr>
<th dir="ltr">Fields</th>
<th dir="ltr">Details</th>
</tr>
</thead>
<tbody>
<tr>
<td dir="ltr">TenantId</td>
<td dir="ltr">The Log Analytics workspace ID.</td>
</tr>
<tr>
<td dir="ltr">TimeGenerated [UTC]</td>
<td dir="ltr">The date and time the request was received.</td>
</tr>
<tr>
<td dir="ltr">AppId</td>
<td dir="ltr">The identifier of the application.</td>
</tr>
<tr>
<td dir="ltr">IPAddress</td>
<td dir="ltr">The IP address of the client from where the request occurred.</td>
</tr>
<tr>
<td dir="ltr">ServicePrincipalId</td>
<td dir="ltr">The identifier of the service principal making the request.</td>
</tr>
<tr>
<td dir="ltr">RequestId</td>
<td dir="ltr">The identifier that represents the request.</td>
</tr>
<tr>
<td dir="ltr">RequestMethod</td>
<td dir="ltr">The HTTP method of the event.</td>
</tr>
<tr>
<td dir="ltr">ResponseStatusCode</td>
<td dir="ltr">The HTTP response status code for the event.</td>
</tr>
<tr>
<td dir="ltr">RequestUri</td>
<td dir="ltr">The URI of the request.</td>
</tr>
<tr>
<td dir="ltr">ResponseSizeBytes</td>
<td dir="ltr">The size of the response in bytes.</td>
</tr>
<tr>
<td dir="ltr">Roles</td>
<td dir="ltr">The roles in token claims.</td>
</tr>
</tbody>
</table></div><div class="el-p"><p dir="auto"><strong>MicrosoftGraphActivityLogs</strong> can be enriched by joining with <strong>IdentityInfo.</strong> For this data to appear, User and Entity Behavior Analytics (UEBA) will need to be enabled. See below for more information:</p></div><div class="el-div"><div data-callout-metadata="" data-callout-fold="" data-callout="important" class="callout"><div class="callout-title" dir="auto"><div class="callout-icon"><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="svg-icon lucide-flame"><path d="M8.5 14.5A2.5 2.5 0 0 0 11 12c0-1.38-.5-2-1-3-1.072-2.143-.224-4.054 2-6 .5 2.5 2 4.9 4 6.5 2 1.6 3 3.5 3 5.5a7 7 0 1 1-14 0c0-1.153.433-2.294 1-3a2.5 2.5 0 0 0 2.5 2.5z"></path></svg></div><div class="callout-title-inner">Important</div></div><div class="callout-content">
<p dir="auto">IdentityInfo is Azure Sentinel’s way to correlate user information. It does not include information about service principals.</p>
<ul>
<li data-line="2" dir="auto">Enabling UEBA: <a data-tooltip-position="top" aria-label="https://learn.microsoft.com/en-us/azure/sentinel/enable-entity-behavior-analytics?tabs=defender%5C#how-to-enable-user-and-entity-behavior-analytics" rel="noopener nofollow" class="external-link" href="https://learn.microsoft.com/en-us/azure/sentinel/enable-entity-behavior-analytics?tabs=defender%5C#how-to-enable-user-and-entity-behavior-analytics" target="_blank">https://learn.microsoft.com/en-us/azure/sentinel/enable-entity-behavior-analytics?tabs=defender\#how-to-enable-user-and-entity-behavior-analytics</a> </li>
<li data-line="3" dir="auto">For more information on Azure Data Explorer, see here: <a data-tooltip-position="top" aria-label="https://learn.microsoft.com/en-us/azure/data-explorer/query-monitor-data%5C#add-a-log-analyticsapplication-insights-workspace-to-azure-data-explorer-client-tools" rel="noopener nofollow" class="external-link" href="https://learn.microsoft.com/en-us/azure/data-explorer/query-monitor-data%5C#add-a-log-analyticsapplication-insights-workspace-to-azure-data-explorer-client-tools" target="_blank">https://learn.microsoft.com/en-us/azure/data-explorer/query-monitor-data\#add-a-log-analyticsapplication-insights-workspace-to-azure-data-explorer-client-tools</a> </li>
<li data-line="4" dir="auto">More info on Entra ID logging: <a rel="noopener nofollow" class="external-link" href="https://learn.microsoft.com/en-us/entra/identity/monitoring-health/howto-analyze-activity-logs-log-analytics" target="_blank">https://learn.microsoft.com/en-us/entra/identity/monitoring-health/howto-analyze-activity-logs-log-analytics</a>  </li>
</ul>
</div></div></div><div class="el-p"><p dir="auto">The data can be queried using <em>Kusto Query Language</em> (KQL). Below are some examples of queries with multiple datasets.</p></div><div class="el-pre"><pre class="language-sql" tabindex="0"><code data-line="0" class="language-sql is-loaded">MicrosoftGraphActivityLogs
<span class="token operator">|</span> <span class="token keyword">where</span> isnotempty<span class="token punctuation">(</span>UserId<span class="token punctuation">)</span>
<span class="token operator">|</span> <span class="token keyword">join</span> kind<span class="token operator">=</span>leftouter IdentityInfo <span class="token keyword">on</span> $<span class="token keyword">left</span><span class="token punctuation">.</span>UserId <span class="token operator">=</span><span class="token operator">=</span> $<span class="token keyword">right</span><span class="token punctuation">.</span>AccountObjectId
<span class="token operator">|</span> <span class="token keyword">where</span> isnotempty<span class="token punctuation">(</span>AccountUPN<span class="token punctuation">)</span>
<span class="token operator">|</span> project<span class="token operator">-</span>reorder TimeGenerated<span class="token punctuation">,</span> AppId<span class="token punctuation">,</span> IPAddress<span class="token punctuation">,</span> AccountUPN<span class="token punctuation">,</span> AccountCreationTime<span class="token punctuation">,</span> AssignedRoles<span class="token punctuation">,</span> ServicePrincipalId<span class="token punctuation">,</span> RequestId<span class="token punctuation">,</span> RequestMethod<span class="token punctuation">,</span> ResponseStatusCode<span class="token punctuation">,</span> RequestUri<span class="token punctuation">,</span> ResponseSizeBytes<span class="token punctuation">,</span> Roles
</code><button class="copy-code-button">Copy</button></pre></div><div class="el-p"><p dir="auto">Combine the <strong>MicrosoftGraphActivityLogs</strong> with the <strong>AadRiskyUser</strong> to get more context on user risk details and levels</p></div><div class="el-pre"><pre class="language-sql" tabindex="0"><code data-line="0" class="language-sql is-loaded">MicrosoftGraphActivityLogs
<span class="token operator">|</span> <span class="token keyword">join</span> AADRiskyUsers <span class="token keyword">on</span> $<span class="token keyword">left</span><span class="token punctuation">.</span>UserId <span class="token operator">=</span><span class="token operator">=</span> $<span class="token keyword">right</span><span class="token punctuation">.</span>Id
</code><button class="copy-code-button">Copy</button></pre></div><div class="el-p"><p dir="auto">Visit the page below for more information with risky users in Entra-ID.<br>
<a data-href="Investigating Risky Users in Entra ID" href="microsoft/security/investigating-risky-users-in-entra-id.html" class="internal-link" target="_self" rel="noopener nofollow">Investigating Risky Users in Entra ID</a></p></div><div class="el-p"><p dir="auto">Geo-IP info: <code>geo_info_from_ip_address</code></p></div><div class="el-pre"><pre class="language-sql" tabindex="0"><code data-line="0" class="language-sql is-loaded">MicrosoftGraphActivityLogs
<span class="token operator">|</span> extend GeoIPInfo <span class="token operator">=</span> geo_info_from_ip_address<span class="token punctuation">(</span>IPAddress<span class="token punctuation">)</span>
<span class="token operator">|</span> extend country <span class="token operator">=</span> tostring<span class="token punctuation">(</span>parse_json<span class="token punctuation">(</span>GeoIPInfo<span class="token punctuation">)</span><span class="token punctuation">.</span>country<span class="token punctuation">)</span>
<span class="token operator">|</span> extend state <span class="token operator">=</span> tostring<span class="token punctuation">(</span>parse_json<span class="token punctuation">(</span>GeoIPInfo<span class="token punctuation">)</span><span class="token punctuation">.</span>state<span class="token punctuation">)</span>
<span class="token operator">|</span> extend city <span class="token operator">=</span> tostring<span class="token punctuation">(</span>parse_json<span class="token punctuation">(</span>GeoIPInfo<span class="token punctuation">)</span><span class="token punctuation">.</span>city<span class="token punctuation">)</span>
</code><button class="copy-code-button">Copy</button></pre></div><div class="el-p"><p dir="auto">Use the <code>parse_url()</code> function to divide data for easy viewing</p></div><div class="el-pre"><pre class="language-sql" tabindex="0"><code data-line="0" class="language-sql is-loaded">MicrosoftGraphActivityLogs
<span class="token operator">|</span> extend ParsedURI <span class="token operator">=</span> parse_url<span class="token punctuation">(</span>RequestUri<span class="token punctuation">)</span>
<span class="token operator">|</span> extend Path <span class="token operator">=</span> tostring<span class="token punctuation">(</span>ParsedURI<span class="token punctuation">.</span>Path<span class="token punctuation">)</span>
</code><button class="copy-code-button">Copy</button></pre></div><div class="el-p"><p dir="auto">If you’d like to remove the API information, use the <code>replace_string()</code> function</p></div><div class="el-pre"><pre class="language-sql" tabindex="0"><code data-line="0" class="language-sql is-loaded">MicrosoftGraphActivityLogs
<span class="token operator">|</span> extend ParsedURI <span class="token operator">=</span> parse_url<span class="token punctuation">(</span>RequestUri<span class="token punctuation">)</span>
<span class="token operator">|</span> extend Path <span class="token operator">=</span> tostring<span class="token punctuation">(</span>ParsedURI<span class="token punctuation">.</span>Path<span class="token punctuation">)</span>
<span class="token operator">|</span> extend FinalPath <span class="token operator">=</span> replace_string<span class="token punctuation">(</span>replace_string<span class="token punctuation">(</span>Path <span class="token punctuation">,</span><span class="token string">'v1.0/'</span><span class="token punctuation">,</span><span class="token string">''</span><span class="token punctuation">)</span><span class="token punctuation">,</span><span class="token string">'beta/'</span><span class="token punctuation">,</span><span class="token string">''</span><span class="token punctuation">)</span>
</code><button class="copy-code-button">Copy</button></pre></div><div class="el-h3 heading-wrapper"><h3 data-heading="Delegated vs. Application permissions" dir="auto" class="heading" id="Delegated_vs._Application_permissions"><div class="heading-collapse-indicator collapse-indicator collapse-icon"><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="svg-icon right-triangle"><path d="M3 8L12 17L21 8"></path></svg></div>Delegated vs. Application permissions</h3><div class="heading-children"><div class="el-table" dir="ltr" style="overflow-x: auto;"><table>
<thead>
<tr>
<th dir="ltr"><strong>Delegated permissions</strong></th>
<th dir="ltr"><strong>Application permissions</strong></th>
</tr>
</thead>
<tbody>
<tr>
<td dir="ltr"><strong>User context</strong></td>
<td dir="ltr">Requires a signed-in user</td>
</tr>
<tr>
<td dir="ltr"><strong>Consent</strong></td>
<td dir="ltr">User consent (or admin on behalf of user)</td>
</tr>
<tr>
<td dir="ltr"><strong>Scope</strong></td>
<td dir="ltr">Limited to user’s permissions</td>
</tr>
<tr>
<td dir="ltr"><strong>Typical use cases</strong></td>
<td dir="ltr">Interactive applications (web, mobile, desktop)</td>
</tr>
<tr>
<td dir="ltr"><strong>Examples</strong></td>
<td dir="ltr">Reading user email, updating user calendar</td>
</tr>
</tbody>
</table></div><div class="el-p"><p dir="auto">Differences between delegated and application permissions</p></div></div></div><div class="el-h2 heading-wrapper"><h2 data-heading="Delegated Permissions" dir="auto" class="heading" id="Delegated_Permissions"><div class="heading-collapse-indicator collapse-indicator collapse-icon"><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="svg-icon right-triangle"><path d="M3 8L12 17L21 8"></path></svg></div>Delegated Permissions</h2><div class="heading-children"><div class="el-ul"><ul>
<li data-line="0" dir="auto">Used when an app acts on behalf of a signed-in user</li>
<li data-line="1" dir="auto">Combine the permissions of both the app and the user</li>
<li data-line="2" dir="auto">Limited by the user's own access rights</li>
<li data-line="3" dir="auto">Suitable for interactive scenarios where a user is present</li>
<li data-line="4" dir="auto">Require user consent (or admin consent for some permissions)</li>
</ul></div></div></div><div class="el-h2 heading-wrapper"><h2 data-heading="Application Permissions" dir="auto" class="heading" id="Application_Permissions"><div class="heading-collapse-indicator collapse-indicator collapse-icon"><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="svg-icon right-triangle"><path d="M3 8L12 17L21 8"></path></svg></div>Application Permissions</h2><div class="heading-children"><div class="el-ul"><ul>
<li data-line="0" dir="auto">Used for app-only access without a user present</li>
<li data-line="1" dir="auto">Grant full access at the app level, not limited by user rights</li>
<li data-line="2" dir="auto">Provide broader access across the tenant</li>
<li data-line="3" dir="auto">Suitable for background services or daemons</li>
<li data-line="4" dir="auto">Always require admin consent</li>
</ul></div><div class="el-h3 heading-wrapper"><h3 data-heading="Security implications" dir="auto" class="heading" id="Security_implications"><div class="heading-collapse-indicator collapse-indicator collapse-icon"><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="svg-icon right-triangle"><path d="M3 8L12 17L21 8"></path></svg></div>Security implications</h3><div class="heading-children"><div class="el-ul"><ul>
<li data-line="0" dir="auto"><strong>Lower risk</strong>: Limited by user's rights, reducing potential for abuse</li>
<li data-line="1" dir="auto"><strong>Auditable</strong>: Actions tied to specific user accounts</li>
<li data-line="2" dir="auto"><strong>Granular control</strong>: Can be scoped to specific users/groups</li>
<li data-line="3" dir="auto"><strong>Higher risk</strong>: Broad access across tenant if compromised</li>
<li data-line="4" dir="auto"><strong>Less accountability</strong>: Actions performed as the app, not a user</li>
<li data-line="5" dir="auto"><strong>Powerful</strong>: Can perform tenant-wide operations</li>
</ul></div></div></div></div></div><div class="el-h1 heading-wrapper"><h1 data-heading="Threat Hunting" dir="auto" class="heading" id="Threat_Hunting">Threat Hunting</h1><div class="heading-children"><div class="el-h3 heading-wrapper"><h3 data-heading="Reconnaissance/Discovery" dir="auto" class="heading" id="Reconnaissance/Discovery"><div class="heading-collapse-indicator collapse-indicator collapse-icon"><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="svg-icon right-triangle"><path d="M3 8L12 17L21 8"></path></svg></div>Reconnaissance/Discovery</h3><div class="heading-children"><div class="el-ul"><ul>
<li data-line="0" dir="auto">enumerating users, groups, roles</li>
<li data-line="1" dir="auto">collecting metadata and configuration details</li>
<li data-line="2" dir="auto">discovering misconfigured mailboxes</li>
<li data-line="3" dir="auto">retrieving app registrations, consents, and scopes</li>
<li data-line="4" dir="auto">many open-source tools available to facilitate these activities</li>
</ul></div><div class="el-p"><p dir="auto">MITRE:<br>
<strong>Mitre technique</strong>:&nbsp;<a data-tooltip-position="top" aria-label="https://attack.mitre.org/techniques/T1087" rel="noopener nofollow" class="external-link" href="https://attack.mitre.org/techniques/T1087" target="_blank">T1087</a><br>
<strong>Attack</strong>: Reconnaissance<br>
<strong>Permissions required:</strong>&nbsp;Various<br>
<strong>RequestURI:</strong>&nbsp;Various</p></div><div class="el-p"><p dir="auto">Below query identifies surges in standard calls within a brief period that have characteristics of reconnaissance tools.</p></div><div class="el-pre"><pre class="language-sql" tabindex="0"><code data-line="0" class="language-sql is-loaded">let calls <span class="token operator">=</span> dynamic<span class="token punctuation">(</span><span class="token punctuation">[</span><span class="token string">"https://graph.microsoft.com/v1.0/users/&lt;UUID&gt;"</span><span class="token punctuation">,</span><span class="token string">"https://graph.microsoft.com/v1.0/search/query"</span><span class="token punctuation">,</span><span class="token string">"https://graph.microsoft.com/beta/policies/authorizationPolicy"</span><span class="token punctuation">,</span><span class="token string">"https://graph.microsoft.com/v1.0/users"</span><span class="token punctuation">,</span><span class="token string">"https://graph.microsoft.com/v1.0/groups"</span><span class="token punctuation">,</span><span class="token string">"https://graph.microsoft.com/v1.0/groups/&lt;UUID&gt;/members"</span><span class="token punctuation">,</span><span class="token string">"https://graph.microsoft.com/v1.0/servicePrincipals"</span><span class="token punctuation">,</span><span class="token string">"https://graph.microsoft.com/v1.0/servicePrincipals/&lt;UUID&gt;"</span><span class="token punctuation">,</span><span class="token string">"https://graph.microsoft.com/v1.0/applications"</span><span class="token punctuation">,</span><span class="token string">"https://graph.microsoft.com/v1.0/servicePrincipals(appId='&lt;UUID&gt;')/appRoleAssignedTo"</span><span class="token punctuation">,</span><span class="token string">"https://graph.microsoft.com/v1.0/organization"</span><span class="token punctuation">,</span><span class="token string">"https://graph.microsoft.com/beta/servicePrincipals"</span><span class="token punctuation">,</span><span class="token string">"https://graph.microsoft.com/beta/servicePrincipals/&lt;UUID&gt;/owners"</span><span class="token punctuation">,</span><span class="token string">"https://graph.microsoft.com/beta/groups/&lt;UUID&gt;/owners"</span><span class="token punctuation">,</span><span class="token string">"https://graph.microsoft.com/beta/groups/&lt;UUID&gt;/members"</span><span class="token punctuation">,</span><span class="token string">"https://graph.microsoft.com/v1.0/servicePrincipals/&lt;UUID&gt;/appRoleAssignedTo"</span><span class="token punctuation">,</span><span class="token string">"https://graph.microsoft.com/beta/applications/&lt;UUID&gt;/owners"</span><span class="token punctuation">,</span><span class="token string">"https://graph.microsoft.com/beta/devices/&lt;UUID&gt;/registeredOwners"</span><span class="token punctuation">,</span><span class="token string">"https://graph.microsoft.com/v1.0/roleManagement/directory/roleAssignments"</span><span class="token punctuation">,</span><span class="token string">"https://graph.microsoft.com/v1.0/roleManagement/directory/roleDefinitions"</span><span class="token punctuation">,</span><span class="token string">"https://graph.microsoft.com/v1.0/devices"</span><span class="token punctuation">,</span><span class="token string">"https://graph.microsoft.com/beta/users/&lt;UUID&gt;/roleManagement/directorytransitiveRoleAssignments"</span><span class="token punctuation">,</span><span class="token string">"https://graph.microsoft.com/v1.0/roleManagement/directory/roleDefinitions/&lt;UUID&gt;"</span><span class="token punctuation">,</span><span class="token string">"https://graph.microsoft.com/beta/roleManagement/directory/estimateAccess"</span><span class="token punctuation">,</span><span class="token string">"https://graph.microsoft.com/beta/users"</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
MicrosoftGraphActivityLogs
<span class="token operator">|</span> <span class="token keyword">where</span> ResponseStatusCode <span class="token operator">=</span><span class="token operator">=</span> <span class="token string">'200'</span>
<span class="token operator">|</span> extend GeneralizedUri <span class="token operator">=</span> replace_regex<span class="token punctuation">(</span>RequestUri<span class="token punctuation">,</span> <span class="token variable">@'\b[0-9a-fA-F]{8}(?:-[0-9a-fA-F]{4}){3}\b-[0-9a-fA-F]{12}'</span><span class="token punctuation">,</span> <span class="token variable">@'&lt;UUID&gt;'</span><span class="token punctuation">)</span>
<span class="token operator">|</span> extend GeneralizedUri <span class="token operator">=</span> replace_string<span class="token punctuation">(</span>GeneralizedUri<span class="token punctuation">,</span> <span class="token variable">@"//"</span><span class="token punctuation">,</span> <span class="token variable">@"/"</span><span class="token punctuation">)</span>
<span class="token operator">|</span> extend GeneralizedUri <span class="token operator">=</span> replace_string<span class="token punctuation">(</span>GeneralizedUri<span class="token punctuation">,</span> <span class="token variable">@"https:/"</span><span class="token punctuation">,</span> <span class="token variable">@"https://"</span><span class="token punctuation">)</span>
<span class="token operator">|</span> extend GeneralizedUri <span class="token operator">=</span> replace_regex<span class="token punctuation">(</span>GeneralizedUri<span class="token punctuation">,</span> <span class="token variable">@'\?.*$'</span><span class="token punctuation">,</span> @"<span class="token string">")
| extend GeneralizedUri = replace_regex(GeneralizedUri, @'/$', @"")
| where GeneralizedUri in (calls)
| extend Id = iff(isempty(UserId), ServicePrincipalId, UserId)
| extend ObjectType = iff(isempty(UserId), "</span>ServicePrincipal<span class="token string">", "</span><span class="token keyword">User</span>"<span class="token punctuation">)</span>
<span class="token operator">|</span> summarize MinTime<span class="token operator">=</span><span class="token function">min</span><span class="token punctuation">(</span>TimeGenerated<span class="token punctuation">)</span><span class="token punctuation">,</span> MaxTime<span class="token operator">=</span><span class="token function">max</span><span class="token punctuation">(</span>TimeGenerated<span class="token punctuation">)</span><span class="token punctuation">,</span> UniqueCalls<span class="token operator">=</span>dcount<span class="token punctuation">(</span>GeneralizedUri<span class="token punctuation">)</span><span class="token punctuation">,</span> CallsMade<span class="token operator">=</span><span class="token function">count</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> UserAgents<span class="token operator">=</span>make_set<span class="token punctuation">(</span>UserAgent<span class="token punctuation">)</span> <span class="token keyword">by</span> IPAddress<span class="token punctuation">,</span> bin<span class="token punctuation">(</span>TimeGenerated<span class="token punctuation">,</span> <span class="token number">2</span>m<span class="token punctuation">)</span><span class="token punctuation">,</span> Id<span class="token punctuation">,</span> ObjectType
<span class="token operator">|</span> <span class="token keyword">where</span> datetime_diff<span class="token punctuation">(</span><span class="token string">'second'</span><span class="token punctuation">,</span> MaxTime<span class="token punctuation">,</span> MinTime<span class="token punctuation">)</span> <span class="token operator">&lt;</span> <span class="token number">100</span> <span class="token operator">and</span> <span class="token punctuation">(</span><span class="token punctuation">(</span>UniqueCalls <span class="token operator">&gt;=</span> <span class="token number">3</span> <span class="token operator">and</span> CallsMade <span class="token operator">&gt;=</span> <span class="token number">40</span><span class="token punctuation">)</span> <span class="token operator">or</span> CallsMade <span class="token operator">&gt;</span> <span class="token number">100</span><span class="token punctuation">)</span>
</code><button class="copy-code-button">Copy</button></pre></div></div></div><div class="el-h3 heading-wrapper"><h3 data-heading="Privilege Escalation" dir="auto" class="heading" id="Privilege_Escalation"><div class="heading-collapse-indicator collapse-indicator collapse-icon"><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="svg-icon right-triangle"><path d="M3 8L12 17L21 8"></path></svg></div>Privilege Escalation</h3><div class="heading-children"><div class="el-ul"><ul>
<li data-line="0" dir="auto">assigning directory roles to users</li>
<li data-line="1" dir="auto">adding users to privileged groups</li>
<li data-line="2" dir="auto">creating service principals</li>
<li data-line="3" dir="auto">assigning roles</li>
</ul></div><div class="el-p"><p dir="auto">With a compromised <em>Service Principal o_f an Entra ID application with the </em><strong>RoleManagement.ReadWrite.Directory</strong><em>, a threat actor has the capability of granting _Global Administrator</em> to another compromised user identity.</p></div><div class="el-p"><p dir="auto"><strong>Mitre technique</strong>:&nbsp;<a data-tooltip-position="top" aria-label="https://attack.mitre.org/techniques/T1098/003/" rel="noopener nofollow" class="external-link" href="https://attack.mitre.org/techniques/T1098/003/" target="_blank">T1098.003</a><br>
<strong>Application&nbsp;Compromised</strong>: Entra<br>
<strong>Attack</strong>: Account manipulation:&nbsp;additional cloud roles<br>
<strong>Permissions required:</strong>&nbsp;RoleManagement.ReadWrite.Directory (Delegated/Application)<br>
<strong>ReqestURI:</strong>&nbsp;<a data-tooltip-position="top" aria-label="https://graph.microsoft.com/%7Bv1.0" rel="noopener nofollow" class="external-link" href="https://graph.microsoft.com/%7Bv1.0" target="_blank">https://graph.microsoft.com/{v1.0</a>&nbsp; | beta}/{directoryRoles/{role-id}/members/$ref<br>
For more details, see&nbsp;<a data-tooltip-position="top" aria-label="https://learn.microsoft.com/en-us/graph/api/directoryrole-post-members?view=graph-rest-1.0&amp;tabs=http" rel="noopener nofollow" class="external-link" href="https://learn.microsoft.com/en-us/graph/api/directoryrole-post-members?view=graph-rest-1.0&amp;tabs=http" target="_blank">Add directory role member.</a></p></div><div class="el-div"><div data-callout-metadata="" data-callout-fold="" data-callout="important" class="callout"><div class="callout-title" dir="auto"><div class="callout-icon"><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="svg-icon lucide-flame"><path d="M8.5 14.5A2.5 2.5 0 0 0 11 12c0-1.38-.5-2-1-3-1.072-2.143-.224-4.054 2-6 .5 2.5 2 4.9 4 6.5 2 1.6 3 3.5 3 5.5a7 7 0 1 1-14 0c0-1.153.433-2.294 1-3a2.5 2.5 0 0 0 2.5 2.5z"></path></svg></div><div class="callout-title-inner">Important</div></div><div class="callout-content">
<p dir="auto">Having specific privileges can allow assignment of higher privileges to other compromised accounts.if the threat actor has enumerated multiple users, they may move laterally to give permissions to another account to establish persistence.  </p>
</div></div></div><div class="el-p"><p dir="auto">The following query detects role changes, including when a new role is added:</p></div><div class="el-pre"><pre class="language-sql" tabindex="0"><code data-line="0" class="language-sql is-loaded">MicrosoftGraphActivityLogs
<span class="token operator">|</span> <span class="token keyword">where</span> RequestUri has_all <span class="token punctuation">(</span><span class="token string">"https://graph.microsoft.com/"</span><span class="token punctuation">,</span> <span class="token string">"/directoryRoles/"</span><span class="token punctuation">,</span> <span class="token string">"members/$ref"</span><span class="token punctuation">)</span>
<span class="token operator">|</span> <span class="token keyword">where</span> RequestMethod <span class="token operator">=</span><span class="token operator">=</span> <span class="token string">"POST"</span>
<span class="token operator">|</span> <span class="token keyword">where</span> ResponseStatusCode <span class="token operator">in</span> <span class="token punctuation">(</span><span class="token string">"204"</span><span class="token punctuation">)</span>
<span class="token operator">|</span> extend Role <span class="token operator">=</span> tostring<span class="token punctuation">(</span>split<span class="token punctuation">(</span>RequestUri<span class="token punctuation">,</span> <span class="token string">"/"</span><span class="token punctuation">)</span><span class="token punctuation">[</span><span class="token operator">-</span><span class="token number">3</span><span class="token punctuation">]</span><span class="token punctuation">)</span> <span class="token comment">//Role can be looked up in Auditlogs</span>
<span class="token operator">|</span> project  TimeGenerated<span class="token punctuation">,</span> IPAddress<span class="token punctuation">,</span> RequestUri<span class="token punctuation">,</span> ResponseStatusCode<span class="token punctuation">,</span> Role<span class="token punctuation">,</span> UserAgent<span class="token punctuation">,</span> AppId
</code><button class="copy-code-button">Copy</button></pre></div></div></div><div class="el-h3 heading-wrapper"><h3 data-heading="Lateral Movement" dir="auto" class="heading" id="Lateral_Movement"><div class="heading-collapse-indicator collapse-indicator collapse-icon"><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="svg-icon right-triangle"><path d="M3 8L12 17L21 8"></path></svg></div>Lateral Movement</h3><div class="heading-children"><div class="el-p"><p dir="auto">Once compromised, the actor can send phishing emails to users within an organization.</p></div><div class="el-ul"><ul>
<li data-line="0" dir="auto">This can lead to further compromised users and facilitates lateral movement.</li>
</ul></div><div class="el-p"><p dir="auto"><strong>Mitre technique</strong>:&nbsp;<a data-tooltip-position="top" aria-label="https://attack.mitre.org/techniques/T1534/" rel="noopener nofollow" class="external-link" href="https://attack.mitre.org/techniques/T1534/" target="_blank">T1534</a><br>
<strong>Application&nbsp;misused</strong>: Exchange Online<br>
<strong>Attack</strong>: Internal phishing<br>
<strong>Permissions required:</strong>&nbsp;Mail.Send (Delegated/Application)<br>
<strong>ReqestURI:</strong>&nbsp;<a data-tooltip-position="top" aria-label="https://graph.microsoft.com/%7Bv1.0" rel="noopener nofollow" class="external-link" href="https://graph.microsoft.com/%7Bv1.0" target="_blank">https://graph.microsoft.com/{v1.0</a>&nbsp; | beta}/{me | users}/{id | userPrincipalName}/sendMail.<br>
For more details, see&nbsp;<a data-tooltip-position="top" aria-label="https://learn.microsoft.com/en-us/graph/api/user-sendmail?view=graph-rest-1.0&amp;tabs=http" rel="noopener nofollow" class="external-link" href="https://learn.microsoft.com/en-us/graph/api/user-sendmail?view=graph-rest-1.0&amp;tabs=http" target="_blank">user: sendMail</a>.</p></div><div class="el-ul"><ul>
<li data-line="0" dir="auto">This essentially allows the threat actor to send emails via JSON format, see examples:</li>
</ul></div><div class="el-p"><p dir="auto">Example #1 - Creates a message with custom Internet message headers and sends the message:</p></div><div class="el-pre"><pre class="language-html" tabindex="0"><code data-line="0" class="language-html is-loaded">POST https://graph.microsoft.com/v1.0/me/sendMail
Content-type: application/json
{
  "message": {
    "subject": "9/9/2018: concert",
    "body": {
      "contentType": "HTML",
      "content": "The group represents Nevada."
    },
    "toRecipients": [
      {
        "emailAddress": {
          "address": "AlexW@contoso.com"
        }
      }
    ],
    "internetMessageHeaders": [
      {
        "name": "x-custom-header-group-name",
        "value": "Nevada"
      },
      {
        "name": "x-custom-header-group-id",
        "value": "NV001"
      }
    ]
  }
}
</code><button class="copy-code-button">Copy</button></pre></div></div></div><div class="el-h3 heading-wrapper"><h3 data-heading="Response" dir="auto" class="heading" id="Response"><div class="heading-collapse-indicator collapse-indicator collapse-icon"><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="svg-icon right-triangle"><path d="M3 8L12 17L21 8"></path></svg></div>Response</h3><div class="heading-children"><div class="el-pre"><pre class="language-html" tabindex="0"><code data-line="0" class="language-html is-loaded">HTTP/1.1 202 Accepted
</code><button class="copy-code-button">Copy</button></pre></div><div class="el-p"><p dir="auto">Example #2 - Creates a message with a file attachment and sends the message</p></div><div class="el-pre"><pre class="language-html" tabindex="0"><code data-line="0" class="language-html is-loaded">POST https://graph.microsoft.com/v1.0/me/sendMail
Content-type: application/json
{
  "message": {
    "subject": "Meet for lunch?",
    "body": {
      "contentType": "Text",
      "content": "The new cafeteria is open."
    },
    "toRecipients": [
      {
        "emailAddress": {
          "address": "meganb@contoso.com"
        }
      }
    ],
    "attachments": [
      {
        "@odata.type": "\#microsoft.graph.fileAttachment",
        "name": "attachment.txt",
        "contentType": "text/plain",
        "contentBytes": "SGVsbG8gV29ybGQh"
      }
    ]
  }
}
</code><button class="copy-code-button">Copy</button></pre></div><div class="el-p"><p dir="auto">Example #3 - Sends a message using MIME format</p></div><div class="el-pre"><pre class="language-html" tabindex="0"><code data-line="0" class="language-html is-loaded">POST https://graph.microsoft.com/v1.0/me/sendMail
Content-type: text/plain
RnJvbTogQWRlbGUgVmFuY2UgPEFkZWxlVkBjb250b3NvLmNvbT4KVG86IEFsZXggV2lsYmVyIDxB
bGV4V0Bjb250b3NvLmNvbT4KU3ViamVjdDpUZXN0IE1lc3NhZ2UKQ29udGVudC1UeXBlOiBtdWx0
aXBhcnQvbWl4ZWQ7Cglib3VuZGFyeT0iXzAwNF9UWVpQUjA0TUI2OTgxNzNGRDAwMjE1MkQ1QURC
OEZCNDdDOEJDQVRZWlBSMDRNQjY5ODFhcGNwXyIKTUlNRS1WZXJzaW9uOiAxLjAKCi0tXzAwNF9U
WVpQUjA0TUI2OTgxNzNGRDAwMjE1MkQ1QURCOEZCNDdDOEJDQVRZWlBSMDRNQjY5ODFhcGNwXwpD
b250ZW50LVR5cGU6IG11bHRpcGFydC9hbHRlcm5hdGl2ZTsKCWJvdW5kYXJ5PSJfMDAwX1RZWlBS
MDRNQjY5ODE3M0ZEMDAyMTUyRDVBREI4RkI0N0M4QkNBVFlaUFIwNE1CNjk4MWFwY3BfIgoKLS1f
MDAwX1RZWlBSMDRNQjY5ODE3M0ZEMDAyMTUyRDVBREI4RkI0N0M4QkNBVFlaUFIwNE1CNjk4MWFw
Y3BfCkNvbnRlbnQtVHlwZTogdGV4dC9wbGFpbjsgY2hhcnNldD0iaXNvLTg4NTktMSIKQ29udGVu
dC1UcmFuc2Zlci1FbmNvZGluZzogcXVvdGVkLXByaW50YWJsZQoKdGVzdCB0ZXh0IGJvZHkKCgot
LV8wMDBfVFlaUFIwNE1CNjk4MTczRkQwMDIxNTJENUFEQjhGQjQ3QzhCQ0FUWVpQUjA0TUI2OTgx
YXBjcF8KQ29udGVudC1UeXBlOiB0ZXh0L2h0bWw7IGNoYXJzZXQ9Imlzby04ODU5LTEiCkNvbnRl
bnQtVHJhbnNmZXItRW5jb2Rpbmc6IHF1b3RlZC1wcmludGFibGUKCjxodG1sPgo8aGVhZD4KPC9o
ZWFkPgo8Ym9keT4KdGVzdCBodG1sIGJvZHkKPC9ib2R5Pgo8L2h0bWw+CgotLV8wMDBfVFlaUFIw
NE1CNjk4MTczRkQwMDIxNTJENUFEQjhGQjQ3QzhCQ0FUWVpQUjA0TUI2OTgxYXBjcF8tLQoKLS1f
MDA0X1RZWlBSMDRNQjY5ODE3M0ZEMDAyMTUyRDVBREI4RkI0N0M4QkNBVFlaUFIwNE1CNjk4MWFw
Y3BfCkNvbnRlbnQtVHlwZTogdGV4dC9wbGFpbjsKQ29udGVudC1EaXNwb3NpdGlvbjogYXR0YWNo
bWVudDsKICAgICAgICBmaWxlbmFtZT0idGVzdC50eHQiCgp0aGlzIGlzIHRoZSBhdHRhY2htZW50
IHRleHQKCi0tXzAwNF9UWVpQUjA0TUI2OTgxNzNGRDAwMjE1MkQ1QURCOEZCNDdDOEJDQVRZWlBS
MDRNQjY5ODFhcGNwXy0t
</code><button class="copy-code-button">Copy</button></pre></div><div class="el-p"><p dir="auto">If the content contains malformed MIME content, an 400 Bad Request error message will show.</p></div><div class="el-p"><p dir="auto">Source: <a rel="noopener nofollow" class="external-link" href="https://learn.microsoft.com/en-us/graph/api/user-sendmail?view=graph-rest-1.0&amp;tabs=http" target="_blank">https://learn.microsoft.com/en-us/graph/api/user-sendmail?view=graph-rest-1.0&amp;tabs=http</a></p></div><div class="mod-footer mod-ui"></div></div></div></div></div></div></div></div><div class="sidebar-right sidebar"><div class="sidebar-handle"></div><div class="sidebar-topbar"><div class="topbar-content"></div><div class="clickable-icon sidebar-collapse-icon"><svg xmlns="http://www.w3.org/2000/svg" width="100%" height="100%" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="3" stroke-linecap="round" stroke-linejoin="round" class="svg-icon"><path d="M21 3H3C1.89543 3 1 3.89543 1 5V19C1 20.1046 1.89543 21 3 21H21C22.1046 21 23 20.1046 23 19V5C23 3.89543 22.1046 3 21 3Z"></path><path d="M10 4V20"></path><path d="M4 7H7"></path><path d="M4 10H7"></path><path d="M4 13H7"></path></svg></div></div><div class="sidebar-content"><div class="graph-view-wrapper"><div class="sidebar-section-header">Interactive Graph</div><div class="graph-view-placeholder">
		<div class="graph-view-container">
			<div class="graph-icon graph-expand" role="button" aria-label="Expand" data-tooltip-position="top"><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="svg-icon"><line x1="7" y1="17" x2="17" y2="7"></line><polyline points="7 7 17 7 17 17"></polyline></svg></div>
			<canvas id="graph-canvas" class="hide" width="512px" height="512px"></canvas>
		</div>
		</div></div><div class="tree-container mod-root nav-folder tree-item outline-tree" data-depth="0"><div class="tree-header"><span class="sidebar-section-header">Table Of Contents</span><button class="clickable-icon collapse-tree-button is-collapsed" aria-label="Collapse All"><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"></svg></button></div><div class="tree-scroll-area tree-item-children nav-folder-children"><div class="tree-item mod-tree-folder nav-folder mod-collapsible is-collapsed" style="display: none;"></div><div class="tree-item" data-depth="1"><a class="tree-link" href="microsoft\security\hunting-with-microsoft-graph-activity-logs.html#Hunting with Microsoft Graph activity logs"><div class="tree-item-contents heading-link" heading-name="Hunting with Microsoft Graph activity logs"><span class="tree-item-title">Hunting with Microsoft Graph activity logs</span></div></a><div class="tree-item-children nav-folder-children"><div class="tree-item" data-depth="3"><a class="tree-link" href="microsoft\security\hunting-with-microsoft-graph-activity-logs.html#Delegated_vs._Application_permissions"><div class="tree-item-contents heading-link" heading-name="Delegated vs. Application permissions"><span class="tree-item-title">Delegated vs. Application permissions</span></div></a><div class="tree-item-children nav-folder-children"></div></div><div class="tree-item" data-depth="2"><a class="tree-link" href="microsoft\security\hunting-with-microsoft-graph-activity-logs.html#Delegated_Permissions"><div class="tree-item-contents heading-link" heading-name="Delegated Permissions"><span class="tree-item-title">Delegated Permissions</span></div></a><div class="tree-item-children nav-folder-children"></div></div><div class="tree-item mod-collapsible is-collapsed" data-depth="2"><a class="tree-link" href="microsoft\security\hunting-with-microsoft-graph-activity-logs.html#Application_Permissions"><div class="tree-item-contents heading-link" heading-name="Application Permissions"><div class="collapse-icon"><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="svg-icon right-triangle"><path d="M3 8L12 17L21 8"></path></svg></div><span class="tree-item-title">Application Permissions</span></div></a><div class="tree-item-children nav-folder-children" style="display: none;"><div class="tree-item" data-depth="3"><a class="tree-link" href="microsoft\security\hunting-with-microsoft-graph-activity-logs.html#Security_implications"><div class="tree-item-contents heading-link" heading-name="Security implications"><span class="tree-item-title">Security implications</span></div></a><div class="tree-item-children nav-folder-children"></div></div></div></div></div></div><div class="tree-item" data-depth="1"><a class="tree-link" href="microsoft\security\hunting-with-microsoft-graph-activity-logs.html#Threat_Hunting"><div class="tree-item-contents heading-link" heading-name="Threat Hunting"><span class="tree-item-title">Threat Hunting</span></div></a><div class="tree-item-children nav-folder-children"><div class="tree-item" data-depth="3"><a class="tree-link" href="microsoft\security\hunting-with-microsoft-graph-activity-logs.html#Reconnaissance/Discovery"><div class="tree-item-contents heading-link" heading-name="Reconnaissance/Discovery"><span class="tree-item-title">Reconnaissance/Discovery</span></div></a><div class="tree-item-children nav-folder-children"></div></div><div class="tree-item" data-depth="3"><a class="tree-link" href="microsoft\security\hunting-with-microsoft-graph-activity-logs.html#Privilege_Escalation"><div class="tree-item-contents heading-link" heading-name="Privilege Escalation"><span class="tree-item-title">Privilege Escalation</span></div></a><div class="tree-item-children nav-folder-children"></div></div><div class="tree-item" data-depth="3"><a class="tree-link" href="microsoft\security\hunting-with-microsoft-graph-activity-logs.html#Lateral_Movement"><div class="tree-item-contents heading-link" heading-name="Lateral Movement"><span class="tree-item-title">Lateral Movement</span></div></a><div class="tree-item-children nav-folder-children"></div></div><div class="tree-item" data-depth="3"><a class="tree-link" href="microsoft\security\hunting-with-microsoft-graph-activity-logs.html#Response"><div class="tree-item-contents heading-link" heading-name="Response"><span class="tree-item-title">Response</span></div></a><div class="tree-item-children nav-folder-children"></div></div></div></div></div></div></div><script defer="">let rs = document.querySelector(".sidebar-right"); rs.classList.add("is-collapsed"); if (window.innerWidth > 768) rs.classList.remove("is-collapsed"); rs.style.setProperty("--sidebar-width", localStorage.getItem("sidebar-right-width"));</script></div></div></body></html>